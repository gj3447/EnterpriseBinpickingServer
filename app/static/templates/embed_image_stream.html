<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <img id="stream" alt="{{ title }} Stream">

    <script>
        const streamId = "{{ stream_id }}";
        const imgElement = document.getElementById('stream');
        
        const wsPath = `/ws/${streamId}`;
        let socket = null;
        let reconnectTimer = null;
        const reconnectDelay = 1000;
        
        // FPS calculation variables
        let frameCount = 0;
        let lastFpsTime = performance.now();
        let currentFps = 0;

        // Create FPS display
        const fpsDisplay = document.createElement('div');
        fpsDisplay.style.position = 'absolute';
        fpsDisplay.style.top = '10px';
        fpsDisplay.style.left = '10px';
        fpsDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        fpsDisplay.style.color = '#00ff00';
        fpsDisplay.style.padding = '5px 10px';
        fpsDisplay.style.fontFamily = 'monospace';
        fpsDisplay.style.fontSize = '14px';
        fpsDisplay.style.borderRadius = '3px';
        fpsDisplay.style.zIndex = '1000';
        document.body.appendChild(fpsDisplay);

        // Update FPS display
        function updateFpsDisplay() {
            const now = performance.now();
            const elapsed = now - lastFpsTime;
            
            if (elapsed >= 1000) {
                currentFps = Math.round((frameCount * 1000) / elapsed);
                fpsDisplay.textContent = `FPS: ${currentFps}`;
                frameCount = 0;
                lastFpsTime = now;
            }
        }

        setInterval(updateFpsDisplay, 100);

        function scheduleReconnect() {
            if (reconnectTimer) {
                return;
            }
            fpsDisplay.textContent = 'FPS: 0 (Reconnecting...)';
            reconnectTimer = setTimeout(() => {
                reconnectTimer = null;
                connect();
            }, reconnectDelay);
        }

        function connect() {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                socket.close();
            }

            socket = new WebSocket(`ws://${window.location.host}${wsPath}`);

            socket.onopen = () => {
                console.log(`WebSocket connected to ${wsPath}`);
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    if (imgElement.src) {
                        URL.revokeObjectURL(imgElement.src);
                    }
                    const typedBlob = new Blob([event.data], { type: 'image/jpeg' });
                    const imageUrl = URL.createObjectURL(typedBlob);
                    imgElement.src = imageUrl;
                    
                    // Increment frame counter
                    frameCount++;
                }
            };

            socket.onclose = (event) => {
                console.log(`WebSocket disconnected from ${wsPath}: ${event.code}`);
                imgElement.src = ""; // Clear image on disconnect
                fpsDisplay.textContent = 'FPS: 0 (Disconnected)';
                scheduleReconnect();
            };
            
            socket.onerror = (error) => {
                console.error(`WebSocket error on ${wsPath}:`, error);
                if (socket && socket.readyState !== WebSocket.CLOSING && socket.readyState !== WebSocket.CLOSED) {
                    socket.close();
                }
                scheduleReconnect();
            };
        }

        connect();
    </script>
</body>
</html>
