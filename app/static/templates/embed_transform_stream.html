<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: monospace; background-color: #1a1a1a; color: #e0e0e0;}
        pre { margin: 10px; padding: 10px; width: calc(100% - 40px); height: calc(100% - 40px); white-space: pre-wrap; word-wrap: break-word; background-color: #2a2a2a; border: 1px solid #444; border-radius: 5px; }
    </style>
</head>
<body>
    <pre id="output">Waiting for connection...</pre>

    <script>
        const streamId = "{{ stream_id }}";
        const outputPre = document.getElementById('output');

        const wsPath = `/ws/${streamId}`;
        const socket = new WebSocket(`ws://${window.location.host}${wsPath}`);
        
        // FPS calculation variables
        let frameCount = 0;
        let lastFpsTime = performance.now();
        let currentFps = 0;

        // Create FPS display
        const fpsDisplay = document.createElement('div');
        fpsDisplay.style.position = 'absolute';
        fpsDisplay.style.top = '10px';
        fpsDisplay.style.right = '10px';
        fpsDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        fpsDisplay.style.color = '#00ff00';
        fpsDisplay.style.padding = '5px 10px';
        fpsDisplay.style.fontFamily = 'monospace';
        fpsDisplay.style.fontSize = '14px';
        fpsDisplay.style.borderRadius = '3px';
        fpsDisplay.style.zIndex = '1000';
        document.body.appendChild(fpsDisplay);

        // Update FPS display
        function updateFpsDisplay() {
            const now = performance.now();
            const elapsed = now - lastFpsTime;
            
            if (elapsed >= 1000) {
                currentFps = Math.round((frameCount * 1000) / elapsed);
                fpsDisplay.textContent = `Updates/sec: ${currentFps}`;
                frameCount = 0;
                lastFpsTime = now;
            }
        }

        setInterval(updateFpsDisplay, 100);

        socket.onopen = () => {
            console.log(`WebSocket connected to ${wsPath}`);
            outputPre.textContent = "Waiting for data...";
        };

        socket.onmessage = (event) => {
            try {
                const transformData = JSON.parse(event.data);
                outputPre.textContent = JSON.stringify(transformData, null, 2);
                
                // Increment frame counter
                frameCount++;
            } catch (e) {
                console.error("Error parsing JSON:", e);
                outputPre.textContent = "Error: Could not parse data from server.";
            }
        };

        socket.onclose = (event) => {
            console.log(`WebSocket disconnected from ${wsPath}: ${event.code}`);
            outputPre.textContent = "Connection Closed.";
            fpsDisplay.textContent = 'Updates/sec: 0 (Disconnected)';
        };
        
        socket.onerror = (error) => {
            console.error(`WebSocket error on ${wsPath}:`, error);
            outputPre.textContent = "Connection Error.";
        }
    </script>
</body>
</html>
